function CreateLeaflet(){(map=L.map("map").setView([-13.1238,-50.8998864],3)).setMinZoom(3),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),L.control.zoom({position:"topright"}).addTo(map)}function InitMap(o){CreateLeaflet(),markersData=JSON.parse(o),gerarTabela(markersData);for(var a=[],e=0;e<markersData.length;e++){a[e]=1;for(var r=e+1;r<markersData.length;r++)markersData[e].dispositivo.nome===markersData[r].dispositivo.nome&&(a[e]=a[e]+1);var n=MaiorPasso(markersData,markersData[e].dispositivo.nome),s=markersData[e].lng,t=markersData[e].lat;void 0!==s&&void 0!==t?createMarkers(t,s,markersData[e],a[e],n):"SOS"==markersData[e].mensagem&&0==markersData[e].visto?NotificacaoSOS():"AJUDA"!=markersData[e].mensagem&&"QUEDA"!=markersData[e].mensagem||0!=markersData[e].visto||NotificacaoAjuda(),void 0!==s&&void 0!==t&&Ligacoes()}}function createMarkers(o,a,e,r,n){if(void 0!==e.userDispositivo[0])s='<div id="iw_container"><div class="iw_title"><strong> Usuário:</strong> '+e.userDispositivo[0].nome+"  &nbsp"+e.userDispositivo[0].sobrenome+' &nbsp <a href="#"  title="Editar Usuario", name="esconderNoInicio" type="button", id="esconderNoInicio" , data-toggle="modal" data-target="#modalUsuario"  onclick=selPersona(\''+JSON.stringify(e.userDispositivo[0],substitui)+'\');> <img class="icone-modal-map" src="images/visualizar.svg"/> </a></div><div class="iw_content"> <strong>Dispositivo:</strong> '+e.dispositivo.nome+"</br><strong> Mensagem:</strong> "+e.mensagem+"</br><strong>Localização: lat</strong>: "+o+"<strong> lon:</strong> "+a+"</br><strong>Data:</strong> "+e.data+"</br><strong>Hora:</strong> "+e.hora+"</div>";else if(e.user)if(void 0==e.user[0])s='<div id="iw_container"><div class="iw_title"><strong> Usuário: </strong>Sem Usuário </div><div class="iw_content"> <strong>Dispositivo:</strong> '+e.dispositivo.nome+"</br> <strong>Mensagem:</strong> "+e.mensagem+"</br><strong>Localização: lat:</strong> "+o+" <strong>lon:</strong> "+a+"</br><strong>Data:</strong> "+e.data+"</br><strong>Hora:</strong> "+e.hora+"</div>";else s='<div id="iw_container"><div class="iw_title"><strong> Usuário:</strong> '+e.user[0].nome+"  &nbsp"+e.user[0].sobrenome+' &nbsp <a href="#"  title="Editar Usuario", name="esconderNoInicio" type="button", id="esconderNoInicio" , data-toggle="modal" data-target="#modalUsuario"  onclick=selPersona(\''+JSON.stringify(e.user[0],substitui)+'\');> <img class="icone-modal-map" src="images/visualizar.svg"/> </a></div><div class="iw_content"><strong> Dispositivo:</strong> '+e.dispositivo.nome+"</br><strong> Mensagem:</strong> "+e.mensagem+"</br><strong>Localização: lat:</strong> "+o+" <strong>lon:</strong> "+a+"</br><strong>Data:</strong> "+e.data+"</br><strong>Hora:</strong> "+e.hora+"</div>";else var s='<div id="iw_container"><div class="iw_title"><strong> Usuário: </strong>Sem Usuário </div><div class="iw_content"> <strong>Dispositivo:</strong> '+e.dispositivo.nome+"</br> <strong>Mensagem:</strong> "+e.mensagem+"</br><strong>Localização: lat:</strong> "+o+" <strong>lon:</strong> "+a+"</br><strong>Data:</strong> "+e.data+"</br><strong>Hora:</strong> "+e.hora+"</div>";var t=new L.LatLng(o,a);posicoesMarkers.push(t);var i=e.visto,c=new L.Marker(t);switch(e.mensagem){case"SIGA-ME":c.setIcon(SigameIcon);break;case"ESTOU-AQUI":c.setIcon(OkIcon);break;case"PERSONALIZADA":c.setIcon(PersonalizadaIcon);break;case"SOS":c.setIcon(AlarmeIcon),c.bounce(),$("#mostrar_notificacao").show(),r!=n||1==i?(c.stopBouncing(),somAlarme.pause(),$("#mostrar_notificacao").hide()):(somAlarme.play(),NotificacaoSOS());break;case"QUEDA":case"AJUDA":c.setIcon(AlarmeIcon),c.bounce(),$("#mostrar_notificacao").show(),r!=n||1==i?(c.stopBouncing(),somAlarme.pause(),$("#mostrar_notificacao").hide()):(somAlarme.play(),NotificacaoAjuda(),$("#mostrar_notificacao").hide())}map.addLayer(c),c.bindLabel(r.toString(),{permanent:!0,direction:"right"}),c.bindPopup(s),map.fitBounds(posicoesMarkers),c.on("click",function(){this.stopBouncing(),somAlarme.pause(),getInformacaoQualquer(e.dispositivo.nome)})}function Ligacoes(){for(var o=0;o<markersData.length;o++)for(var a=!0,e=cores[Math.floor(markersData[o].dispositivo.nome[markersData[o].dispositivo.nome.length-1])],r=o+1;r<markersData.length;r++)if(markersData[o].dispositivo.nome==markersData[r].dispositivo.nome&&a&&void 0!==markersData[o].lng&&void 0!==markersData[o].lat&&void 0!==markersData[r].lng&&void 0!==markersData[r].lat){var n=[[markersData[o].lat,markersData[o].lng],[markersData[r].lat,markersData[r].lng]];L.polyline(n,{color:e}).addTo(map);a=!1}}function MaiorPasso(o,a){for(var e=0,r=0;r<o.length;r++)o[r].dispositivo.nome==a&&e++;return e}function mostrarMarker(o,a,e){for(var r=0;r<markersData.length;r++)if(o==markersData[r].dispositivo.nome&&a==markersData[r].hora)if(void 0!==markersData[r].lng&&void 0!==markersData[r].lat){var n=new L.LatLng(markersData[r].lat,markersData[r].lng);map.setView(n,13);var s=new L.Marker(n);switch(e){case"SIGA-ME":s.setIcon(SigameIcon),s.bounce(2);break;case"ESTOU-AQUI":s.setIcon(OkIcon),s.bounce(2);break;case"PERSONALIZADA":s.setIcon(PersonalizadaIcon),s.bounce(2);break;case"SOS":s.setIcon(AlarmeIcon),s.bounce(2);break;case"QUEDA":case"AJUDA":s.setIcon(AlarmeIcon),s.bounce(2)}setTimeout(function(){map.removeLayer(s)},750),getInformacaoQualquer(o),map.addLayer(s)}else getInformacaoQualquer(o),alert("Sem Localização!")}function EstacaoRevisada(o){1!=document.getElementById("checkbox1").checked||"LIFELINK"!=o&&"VLI"!=o&&"ATHENE"!=o&&"MEDICAR"!=o?estacaoRevisada.removeFrom(map):estacaoRevisada=omnivore.kml("kml/estacaoRevisada2.kml").on("ready",function(o){this.eachLayer(function(o){o.setIcon(EstacaoIcon);var a=o.toGeoJSON().properties.name;o.bindPopup(a)})}).addTo(map)}function ExtensoEstacao(o){1!=document.getElementById("checkbox2").checked||"LIFELINK"!=o&&"VLI"!=o&&"ATHENE"!=o&&"MEDICAR"!=o?meioAmbiente.removeFrom(map):meioAmbiente=omnivore.kml("kml/estacoesExtenso.kml").on("ready",function(o){this.eachLayer(function(o){o.setIcon(EstacaoIcon);var a=o.toGeoJSON().properties.name;o.bindPopup(a)})}).addTo(map)}function FerroTrecho(o){1!=document.getElementById("checkbox3").checked||"LIFELINK"!=o&&"VLI"!=o&&"ATHENE"!=o&&"MEDICAR"!=o?trechoFerro.removeFrom(map):trechoFerro=omnivore.kml("kml/trechoFerroviario.kml",null,customLayer).on("ready",function(){map.fitBounds(trechoFerro)}).addTo(map)}function AtlanticaLinha(o){1!=document.getElementById("checkbox4").checked||"LIFELINK"!=o&&"VLI"!=o&&"ATHENE"!=o&&"MEDICAR"!=o?atlantica.removeFrom(map):atlantica=omnivore.kml("kml/meioAmbienteAtlantica.kml",null,customLayer).on("ready",function(){map.fitBounds(atlantica)}).addTo(map)}var map,markersData,estacaoRevisada,meioAmbiente,trechoFerro,atlantica,posicoesMarkers=new Array,SosIcon=L.icon({iconUrl:"images/SOS.png",iconSize:[25,41],shadowSize:[50,70],iconAnchor:[14,40],shadowAnchor:[0,69],popupAnchor:[-8,-39],labelAnchor:[8,-30]}),AlarmeIcon=L.icon({iconUrl:"images/Alarme.png",iconSize:[25,41],shadowSize:[50,70],iconAnchor:[14,40],shadowAnchor:[0,69],popupAnchor:[-8,-39],labelAnchor:[8,-30]}),SigameIcon=L.icon({iconUrl:"images/sigaMe.png",iconSize:[25,41],shadowSize:[50,70],iconAnchor:[14,40],shadowAnchor:[0,69],popupAnchor:[-8,-39],labelAnchor:[8,-30]}),OkIcon=L.icon({iconUrl:"images/OK.png",iconSize:[25,41],shadowSize:[50,70],iconAnchor:[14,40],shadowAnchor:[0,69],popupAnchor:[-8,-39],labelAnchor:[8,-30]}),EstacaoIcon=L.icon({iconUrl:"images/estacao.png",iconSize:[25,25],shadowSize:[50,70],iconAnchor:[14,40],shadowAnchor:[0,69],popupAnchor:[-8,-39]}),PersonalizadaIcon=L.icon({iconUrl:"images/Personalizada.png",iconSize:[25,41],shadowSize:[50,70],iconAnchor:[14,40],shadowAnchor:[0,69],popupAnchor:[-8,-39],labelAnchor:[8,-30]}),somAlarme=new Audio("audio/Alarme.mp3"),cores=["#000080","#FF1493","#FF4500","#006400","#000000 ","#660066 ","#993333","#003300 "],customLayer=L.geoJson(null,{style:function(o){return{color:"#f00"}}});